<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge Investigations - Epstein Files</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/sidebar.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-input: #1a1a3a;
            --accent: #00d4ff;
            --accent-purple: #a855f7;
            --accent-gold: #ffd700;
            --accent-red: #ff6b6b;
            --text: #e0e0e0;
            --text-muted: #888;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a3a 0%, #0a0a1a 100%);
            border-bottom: 1px solid rgba(168, 85, 247, 0.3);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i { font-size: 28px; color: var(--accent-purple); }

        .logo h1 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--accent-purple), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links a {
            color: var(--text-muted);
            text-decoration: none;
            margin-left: 30px;
            transition: color 0.3s;
        }

        .nav-links a:hover { color: var(--accent); }
        .nav-links a.active { color: var(--accent-purple); }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px;
            width: 100%;
        }

        .page-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title h2 {
            color: var(--accent-purple);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-title p {
            color: var(--text-muted);
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }

        .panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.05);
            min-width: 0; /* Allows content to shrink */
        }

        .panel h3 {
            color: var(--accent-purple);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .investigation-list {
            max-height: calc(100vh - 400px);
            min-height: 300px;
            overflow-y: auto;
        }

        .investigation-item {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .investigation-item:hover {
            border-color: var(--accent-purple);
        }

        .investigation-item.selected {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.1);
        }

        .investigation-item .title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .investigation-item .meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .investigation-item .stats {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .investigation-item .stat {
            background: rgba(0, 212, 255, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent);
        }

        .selected-panel {
            min-height: 200px;
        }

        .selected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .selected-tag {
            background: var(--accent-purple);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-tag .remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .selected-tag .remove:hover {
            opacity: 1;
        }

        .merge-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-purple), #c084fc);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .merge-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(168, 85, 247, 0.4);
        }

        .merge-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .results-panel {
            grid-column: 1 / -1;
            display: none;
        }

        .results-panel.active {
            display: block;
        }

        .results-content {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 25px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.7;
        }

        .results-content p {
            margin-bottom: 15px;
        }

        .results-content h4 {
            color: var(--accent-gold);
            margin: 20px 0 10px;
        }

        .results-content h4:first-child {
            margin-top: 0;
        }

        .results-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .results-content li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .connection-card {
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .connection-card .from-to {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-purple);
            margin-bottom: 8px;
        }

        .connection-card .evidence {
            font-size: 13px;
            color: var(--text-muted);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 40px;
            color: var(--accent-purple);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .network-preview {
            height: 300px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-top: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <script src="/static/sidebar.js"></script>
    <header class="header">
        <div class="logo">
            <i class="fas fa-code-merge"></i>
            <h1>Merge Investigations</h1>
        </div>
    </header>

    <div class="container">
        <div class="page-title">
            <h2><i class="fas fa-project-diagram"></i> Merge Investigations</h2>
            <p>Select multiple saved investigations to find hidden connections and build a complete picture</p>
        </div>

        <!-- Saved merges -->
        <div class="panel" style="margin-bottom: 30px;" id="savedMergesPanel">
            <h3><i class="fas fa-history"></i> Previous Merges</h3>
            <div id="savedMergesList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div class="loading"><i class="fas fa-spinner"></i></div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Available investigations list -->
            <div class="panel">
                <h3><i class="fas fa-folder-open"></i> Saved Investigations</h3>
                <div class="investigation-list" id="investigationList">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Current selection -->
            <div class="panel selected-panel">
                <h3><i class="fas fa-check-circle"></i> Selected for Merge</h3>
                <div class="selected-list" id="selectedList">
                    <div class="empty-state">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Click on investigations on the left to select them</p>
                    </div>
                </div>
                <button class="merge-btn" id="mergeBtn" onclick="mergeInvestigations()" disabled>
                    <i class="fas fa-magic"></i> Merge and Analyze Connections
                </button>
            </div>

            <!-- Merge results -->
            <div class="panel results-panel" id="resultsPanel">
                <h3><i class="fas fa-lightbulb"></i> Connection Analysis</h3>
                <div class="results-content" id="resultsContent">
                </div>
            </div>
        </div>
    </div>

    <script>
        let investigations = [];
        let selectedIds = new Set();
        let currentMergeId = null;  // Current merge ID for integrating findings

        // Load saved investigations
        async function loadInvestigations() {
            try {
                const response = await fetch('/api/investigations/list');
                const data = await response.json();
                investigations = data.investigations || [];
                renderInvestigations();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('investigationList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Loading error</p>
                    </div>
                `;
            }
        }

        // Render investigations list
        function renderInvestigations() {
            const container = document.getElementById('investigationList');

            if (investigations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No saved investigations.<br>Go to Investigation Crew to create one.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = investigations.map(inv => `
                <div class="investigation-item ${selectedIds.has(inv.id) ? 'selected' : ''}"
                     onclick="toggleSelection('${inv.id}')">
                    <div class="title">${inv.objective || 'Untitled investigation'}</div>
                    <div class="meta">
                        <span><i class="fas fa-calendar"></i> ${formatDate(inv.date)}</span>
                        <span><i class="fas fa-file-alt"></i> ${inv.documents_found || 0} documents</span>
                    </div>
                    <div class="stats">
                        ${(inv.people || []).slice(0, 3).map(p => `<span class="stat">${p}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Toggle selection
        function toggleSelection(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderInvestigations();
            renderSelected();
            updateMergeButton();
        }

        // Render selection
        function renderSelected() {
            const container = document.getElementById('selectedList');

            if (selectedIds.size === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Click on investigations on the left to select them</p>
                    </div>
                `;
                return;
            }

            const selected = investigations.filter(inv => selectedIds.has(inv.id));
            container.innerHTML = selected.map(inv => `
                <div class="selected-tag">
                    ${(inv.objective || '').substring(0, 30)}...
                    <span class="remove" onclick="event.stopPropagation(); toggleSelection('${inv.id}')">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `).join('');
        }

        // Update merge button
        function updateMergeButton() {
            const btn = document.getElementById('mergeBtn');
            btn.disabled = selectedIds.size < 2;
            btn.innerHTML = selectedIds.size < 2
                ? '<i class="fas fa-magic"></i> Select at least 2 investigations'
                : `<i class="fas fa-magic"></i> Merge ${selectedIds.size} Investigations`;
        }

        // Execute merge
        async function mergeInvestigations() {
            const btn = document.getElementById('mergeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analysis in progress...';

            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');

            resultsPanel.classList.add('active');
            resultsContent.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Merging investigations and searching for connections...</p>
                </div>
            `;

            try {
                // Start merge in background
                const startResponse = await fetch('/api/investigations/merge', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        investigation_ids: Array.from(selectedIds)
                    })
                });

                const startData = await startResponse.json();

                if (startData.error) {
                    throw new Error(startData.error);
                }

                const mergeId = startData.merge_id;

                // Polling to check status (no limit)
                let attempts = 0;

                const checkStatus = async () => {
                    attempts++;
                    const statusResponse = await fetch(`/api/investigations/merge/status/${mergeId}`);
                    const statusData = await statusResponse.json();

                    if (statusData.status === 'completed') {
                        currentMergeId = mergeId;  // Save for future integrations
                        renderResults(statusData.result);
                        loadSavedMerges();
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-magic"></i> Merge ${selectedIds.size} Investigations`;
                    } else if (statusData.status === 'error') {
                        throw new Error(statusData.error || 'Error during merge');
                    } else {
                        // Update wait message
                        resultsContent.innerHTML = `
                            <div class="loading">
                                <i class="fas fa-spinner"></i>
                                <p>Analysis in progress... (${attempts}s)</p>
                                <p style="font-size: 12px; color: var(--text-muted);">Downloading documents and analyzing with Claude</p>
                            </div>
                        `;
                        setTimeout(checkStatus, 1000);
                    }
                };

                await checkStatus();
                return; // Don't disable button here, checkStatus does it

            } catch (error) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }

            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-magic"></i> Merge ${selectedIds.size} Investigations`;
        }

        // Render results
        function renderResults(data) {
            const container = document.getElementById('resultsContent');

            let html = '';

            // Header with stats
            if (data.documents_analyzed && data.documents_analyzed.length > 0) {
                html += `
                    <div style="background: rgba(168, 85, 247, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--accent-purple);">
                        <div style="font-size: 14px; color: var(--accent-purple); font-weight: 600;">
                            <i class="fas fa-robot"></i> Agents analyzed ${data.documents_analyzed.length} critical documents
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
                            ${data.documents_analyzed.join(', ')}
                        </div>
                    </div>
                `;
            }

            // Summary
            if (data.summary) {
                html += `<h4><i class="fas fa-file-alt"></i> Summary</h4>`;
                html += `<p>${data.summary}</p>`;
            }

            // Critical findings from documents
            if (data.critical_findings && data.critical_findings.length > 0) {
                html += `<h4 style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Critical Findings from Documents</h4>`;
                html += `<ul style="background: rgba(255, 107, 107, 0.1); padding: 15px 15px 15px 35px; border-radius: 8px; border-left: 3px solid #ff6b6b;">`;
                data.critical_findings.forEach(f => {
                    html += `<li style="margin-bottom: 10px;">${f}</li>`;
                });
                html += `</ul>`;
            }

            // Specific document analysis
            if (data.document_analysis && data.document_analysis.length > 0) {
                html += `<h4><i class="fas fa-file-search"></i> Downloaded Documents Analysis</h4>`;
                data.document_analysis.forEach(doc => {
                    html += `
                        <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--accent);">
                            <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">
                                <i class="fas fa-file-pdf"></i> ${doc.doc_id}
                            </div>
                            <div style="margin-bottom: 8px;">${doc.key_content || ''}</div>
                            <div style="font-size: 12px; color: var(--accent-gold);">
                                <i class="fas fa-star"></i> ${doc.relevance || ''}
                            </div>
                        </div>
                    `;
                });
            }

            // Found connections
            if (data.connections && data.connections.length > 0) {
                html += `<h4><i class="fas fa-link"></i> Connections Found</h4>`;
                data.connections.forEach(conn => {
                    html += `
                        <div class="connection-card">
                            <div class="from-to">${conn.from} ↔ ${conn.to}</div>
                            <div class="type">${conn.type || ''}</div>
                            <div class="evidence">Evidence: ${conn.evidence || 'N/A'}</div>
                        </div>
                    `;
                });
            }

            // Common people
            if (data.common_people && data.common_people.length > 0) {
                html += `<h4><i class="fas fa-users"></i> Common People</h4>`;
                html += `<ul>`;
                data.common_people.forEach(p => {
                    html += `<li><strong>${p.name}</strong> - ${p.role || ''} (appears in ${p.count} investigations)</li>`;
                });
                html += `</ul>`;
            }

            // Identified patterns
            if (data.patterns && data.patterns.length > 0) {
                html += `<h4><i class="fas fa-fingerprint"></i> Identified Patterns</h4>`;
                html += `<ul>`;
                data.patterns.forEach(p => {
                    html += `<li>${p}</li>`;
                });
                html += `</ul>`;
            }

            // Key insight
            if (data.key_insight) {
                html += `
                    <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.1)); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--accent-gold);">
                        <h4 style="color: var(--accent-gold); margin: 0 0 10px 0;"><i class="fas fa-key"></i> Key Finding</h4>
                        <p style="font-size: 15px; margin: 0;">${data.key_insight}</p>
                    </div>
                `;
            }

            // Recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                html += `<h4><i class="fas fa-lightbulb"></i> Recommendations for Further Investigation</h4>`;
                html += `<ul>`;
                data.recommendations.forEach(r => {
                    html += `<li>${r}</li>`;
                });
                html += `</ul>`;
            }

            // Accumulated deep dives (in-depth analyses done after the merge)
            if (data.deep_dives && data.deep_dives.length > 0) {
                html += `
                    <h4 style="margin-top: 25px;"><i class="fas fa-microscope"></i> Deep Analyses (${data.deep_dives.length} documents)</h4>
                `;
                data.deep_dives.forEach(dd => {
                    html += `
                        <div style="background: var(--bg-card); padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div style="font-weight: 600; color: var(--accent-purple); font-size: 15px; margin-bottom: 10px;">
                                <i class="fas fa-file-alt"></i> ${dd.doc_id || 'N/A'}
                                ${dd.title ? `<span style="font-weight: 400; font-size: 12px; color: var(--text-muted); margin-left: 10px;">${dd.title}</span>` : ''}
                            </div>
                    `;
                    if (dd.document_summary) {
                        html += `<p style="margin-bottom: 10px; font-size: 13px;">${dd.document_summary}</p>`;
                    }
                    if (dd.key_findings && dd.key_findings.length > 0) {
                        html += `<div style="margin-bottom: 10px;"><strong style="color: var(--accent-gold); font-size: 12px;"><i class="fas fa-star"></i> Findings:</strong>`;
                        html += `<ul style="margin: 5px 0 0 20px; font-size: 13px;">`;
                        dd.key_findings.forEach(f => html += `<li>${f}</li>`);
                        html += `</ul></div>`;
                    }
                    if (dd.financial_transactions && dd.financial_transactions.length > 0) {
                        html += `<div style="margin-bottom: 10px;"><strong style="color: #2ed573; font-size: 12px;"><i class="fas fa-money-bill-wave"></i> Transactions:</strong>`;
                        dd.financial_transactions.forEach(t => {
                            html += `<div style="background: rgba(46, 213, 115, 0.1); padding: 6px 10px; border-radius: 4px; margin: 4px 0; font-size: 12px; border-left: 2px solid #2ed573;">
                                <strong>${t.amount || ''}</strong> ${t.from || ''} → ${t.to || ''} ${t.date ? '(' + t.date + ')' : ''} ${t.purpose ? '- ' + t.purpose : ''}
                            </div>`;
                        });
                        html += `</div>`;
                    }
                    if (dd.red_flags && dd.red_flags.length > 0) {
                        html += `<div style="margin-bottom: 10px;"><strong style="color: #ff6b6b; font-size: 12px;"><i class="fas fa-flag"></i> Red Flags:</strong>`;
                        html += `<ul style="margin: 5px 0 0 20px; font-size: 12px; color: #ff6b6b;">`;
                        dd.red_flags.forEach(f => html += `<li>${f}</li>`);
                        html += `</ul></div>`;
                    }
                    if (dd.trafficking_references && dd.trafficking_references.length > 0) {
                        html += `<div style="background: rgba(255, 0, 0, 0.1); padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid rgba(255,0,0,0.3);">
                            <strong style="color: #ff0000; font-size: 12px;"><i class="fas fa-skull-crossbones"></i> Trafficking:</strong>`;
                        dd.trafficking_references.forEach(t => html += `<p style="font-size: 12px; font-style: italic; margin: 4px 0;">"${t}"</p>`);
                        html += `</div>`;
                    }
                    if (dd.conclusion) {
                        html += `<div style="font-size: 12px; color: var(--accent); margin-top: 8px;"><i class="fas fa-gavel"></i> ${dd.conclusion}</div>`;
                    }
                    html += `</div>`;
                });
            }

            // Full report
            if (data.full_report) {
                html += `<h4><i class="fas fa-scroll"></i> Full Report</h4>`;
                html += `<div style="white-space: pre-wrap; font-size: 13px; line-height: 1.7; background: var(--bg-dark); padding: 20px; border-radius: 8px;">${data.full_report}</div>`;
            }

            // CONTINUE INVESTIGATION SECTION
            const analyzedDocs = data.documents_analyzed || [];

            // Leads to follow up (new unanalyzed documents)
            if (data.leads_to_follow && data.leads_to_follow.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.1)); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--accent-red);">
                        <h4 style="color: var(--accent-red); margin: 0 0 15px 0;">
                            <i class="fas fa-exclamation-circle"></i> ${data.leads_to_follow.length} New Documents to Investigate
                        </h4>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                            Critical documents mentioned that have not yet been examined.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                `;

                data.leads_to_follow.forEach(lead => {
                    const priorityColor = lead.priority === 'high' ? '#ff6b6b' : '#ffd700';
                    html += `
                        <div style="background: var(--bg-input); padding: 12px 15px; border-radius: 8px; border-left: 3px solid ${priorityColor}; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--accent);">${lead.doc_id}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${(lead.reason || '').substring(0, 150)}...</div>
                            </div>
                            <button onclick="deepDive('${lead.doc_id}', '${(lead.reason || '').replace(/'/g, "\\'")}'); event.stopPropagation();"
                                    style="padding: 8px 16px; background: var(--accent-red); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 15px;">
                                <i class="fas fa-search-plus"></i> Investigate
                            </button>
                        </div>
                    `;
                });

                html += `</div></div>`;
            }

            // ALWAYS show section to deepen already analyzed documents
            if (analyzedDocs.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1)); padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--accent-purple);">
                        <h4 style="color: var(--accent-purple); margin: 0 0 15px 0;">
                            <i class="fas fa-robot"></i> Want to continue the investigation?
                        </h4>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                            Click on a document for a deeper analysis (full content, people, transactions).
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                `;

                analyzedDocs.forEach(docId => {
                    html += `
                        <button type="button" onclick="event.preventDefault(); deepDive('${docId}', 'Deepening requested'); return false;"
                                style="padding: 10px 16px; background: var(--bg-input); border: 1px solid var(--accent-purple); color: var(--accent); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;"
                                onmouseover="this.style.background='var(--accent-purple)'; this.style.color='white'"
                                onmouseout="this.style.background='var(--bg-input)'; this.style.color='var(--accent)'">
                            <i class="fas fa-file-alt"></i> ${docId}
                        </button>
                    `;
                });

                html += `
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(168, 85, 247, 0.3); display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <button type="button" onclick="event.preventDefault(); deepDiveAll(${JSON.stringify(analyzedDocs).replace(/"/g, '&quot;')}); return false;"
                                    style="padding: 12px 24px; background: var(--accent-purple); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-search-plus"></i> Analyze ALL in depth
                            </button>
                            <div style="display: flex; gap: 8px; flex: 1; min-width: 250px;">
                                <input type="text" id="searchMoreDocs" placeholder="Search for more documents (name, term)..."
                                       style="flex: 1; padding: 12px 16px; background: var(--bg-input); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; color: var(--text); font-size: 14px;"
                                       onkeypress="if(event.key==='Enter') searchMoreDocuments()">
                                <button type="button" onclick="event.preventDefault(); searchMoreDocuments(); return false;"
                                        style="padding: 12px 20px; background: var(--accent); border: none; color: #000; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html || '<p>No connections found between the selected investigations.</p>';

            // Scroll to results
            document.getElementById('resultsPanel').scrollIntoView({behavior: 'smooth'});
        }

        // Search for more related documents
        async function searchMoreDocuments() {
            const query = document.getElementById('searchMoreDocs').value.trim();
            if (!query) {
                alert('Enter a search term');
                return;
            }

            const resultsContent = document.getElementById('resultsContent');

            // Add search results section
            const searchResultsDiv = document.createElement('div');
            searchResultsDiv.innerHTML = `
                <div style="background: rgba(0, 212, 255, 0.1); padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid var(--accent);">
                    <h4 style="color: var(--accent); margin: 0 0 15px 0;">
                        <i class="fas fa-spinner fa-spin"></i> Searching "${query}" on Justice.gov...
                    </h4>
                    <div id="search-more-results"></div>
                </div>
            `;
            resultsContent.appendChild(searchResultsDiv);
            searchResultsDiv.scrollIntoView({behavior: 'smooth'});

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, page: 0})
                });
                const data = await response.json();

                const resultsDiv = document.getElementById('search-more-results');

                if (data.results && data.results.length > 0) {
                    searchResultsDiv.querySelector('h4').innerHTML = `
                        <i class="fas fa-file-search"></i> Found ${data.results.length} documents for "${query}"
                    `;

                    resultsDiv.innerHTML = data.results.slice(0, 10).map(doc => {
                        const docId = doc.url ? doc.url.match(/EFTA\d+/)?.[0] || 'N/A' : 'N/A';
                        return `
                            <div style="padding: 12px; margin: 8px 0; background: var(--bg-input); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--accent);">${docId}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${(doc.title || '').substring(0, 100)}</div>
                                    ${doc.snippets ? `<div style="font-size: 11px; color: var(--text); margin-top: 4px; font-style: italic;">"${doc.snippets[0]?.substring(0, 150) || ''}..."</div>` : ''}
                                </div>
                                <button onclick="deepDive('${docId}', 'Search: ${query.replace(/'/g, "\\'")}');"
                                        style="padding: 8px 16px; background: var(--accent-purple); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap; margin-left: 15px;">
                                    <i class="fas fa-search-plus"></i> Analyze
                                </button>
                            </div>
                        `;
                    }).join('');
                } else {
                    searchResultsDiv.querySelector('h4').innerHTML = `
                        <i class="fas fa-exclamation-circle"></i> No results for "${query}"
                    `;
                    resultsDiv.innerHTML = '<p style="color: var(--text-muted);">Try different terms.</p>';
                }
            } catch (error) {
                document.getElementById('search-more-results').innerHTML = `
                    <p style="color: var(--accent-red);">Search error: ${error.message}</p>
                `;
            }
        }

        // AUTOMATIC deep dive of all documents
        async function deepDiveAll(docIds) {
            const resultsContent = document.getElementById('resultsContent');

            // Add container for automatic results
            const autoContainer = document.createElement('div');
            autoContainer.id = 'auto-deep-dive-results';
            autoContainer.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(168, 85, 247, 0.1)); padding: 20px; border-radius: 10px; margin-top: 20px; border: 1px solid var(--accent);">
                    <h4 style="color: var(--accent); margin: 0 0 15px 0;">
                        <i class="fas fa-robot fa-spin"></i> Automatic Investigation in Progress
                    </h4>
                    <p style="font-size: 13px; color: var(--text-muted);">
                        Analyzing ${docIds.length} documents in depth...
                    </p>
                    <div id="auto-progress" style="margin-top: 15px;"></div>
                </div>
            `;
            resultsContent.appendChild(autoContainer);
            autoContainer.scrollIntoView({behavior: 'smooth'});

            const progressDiv = document.getElementById('auto-progress');
            let allFindings = [];

            for (let i = 0; i < docIds.length; i++) {
                const docId = docIds[i];
                progressDiv.innerHTML += `
                    <div id="progress-${docId}" style="padding: 8px; margin: 5px 0; background: var(--bg-input); border-radius: 6px;">
                        <i class="fas fa-spinner fa-spin" style="color: var(--accent-purple);"></i>
                        <span id="progress-text-auto-${docId}" style="margin-left: 10px;">${docId} - Starting analysis... (${i+1}/${docIds.length})</span>
                    </div>
                `;

                try {
                    // Start the job
                    const startResponse = await fetch('/api/investigations/deep-dive', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({doc_id: docId, context: 'Automatic investigation'})
                    });
                    const startData = await startResponse.json();

                    if (startData.error) {
                        document.getElementById(`progress-${docId}`).innerHTML = `
                            <i class="fas fa-times" style="color: var(--accent-red);"></i>
                            <span style="margin-left: 10px;">${docId} - Error: ${startData.error}</span>
                        `;
                        continue;
                    }

                    const jobId = startData.job_id;

                    // Polling for this document
                    let data = null;
                    while (true) {
                        await new Promise(resolve => setTimeout(resolve, 2000));

                        const statusResponse = await fetch(`/api/investigations/deep-dive/status/${jobId}`);
                        const status = await statusResponse.json();

                        // Update progress
                        const progressSpan = document.getElementById(`progress-text-auto-${docId}`);
                        if (progressSpan && status.progress) {
                            progressSpan.textContent = `${docId} - ${status.progress} (${i+1}/${docIds.length})`;
                        }

                        if (status.status === 'completed') {
                            data = status.result;
                            break;
                        } else if (status.status === 'error') {
                            throw new Error(status.error || 'Error during analysis');
                        }
                    }

                    allFindings.push({docId, data});
                    const keyFindings = (data.key_findings || []).slice(0, 2).join('; ');
                    document.getElementById(`progress-${docId}`).innerHTML = `
                        <i class="fas fa-check" style="color: #4ade80;"></i>
                        <span style="margin-left: 10px; color: var(--accent);">${docId}</span>
                        <span style="margin-left: 10px; font-size: 12px; color: var(--text-muted);">${keyFindings || 'Analysis completed'}</span>
                    `;
                } catch (error) {
                    document.getElementById(`progress-${docId}`).innerHTML = `
                        <i class="fas fa-times" style="color: var(--accent-red);"></i>
                        <span style="margin-left: 10px;">${docId} - Error: ${error.message}</span>
                        <button onclick="deepDive('${docId}', 'Automatic retry')" style="margin-left: 10px; padding: 4px 10px; background: var(--accent-purple); border: none; color: white; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    `;
                }
            }

            // Show final summary
            if (allFindings.length > 0) {
                let summaryHtml = `
                    <div style="margin-top: 20px; padding: 20px; background: rgba(74, 222, 128, 0.1); border-radius: 10px; border: 1px solid #4ade80;">
                        <h4 style="color: #4ade80; margin: 0 0 15px 0;">
                            <i class="fas fa-flag-checkered"></i> Investigation Complete - ${allFindings.length} documents analyzed
                        </h4>
                `;

                allFindings.forEach(({docId, data}) => {
                    summaryHtml += `
                        <div style="margin: 10px 0; padding: 10px; background: var(--bg-input); border-radius: 6px;">
                            <strong style="color: var(--accent);">${docId}</strong>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">
                                ${data.document_summary || 'N/A'}
                            </div>
                            ${data.red_flags && data.red_flags.length > 0 ? `
                                <div style="font-size: 12px; color: var(--accent-red); margin-top: 5px;">
                                    <i class="fas fa-flag"></i> ${data.red_flags.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                summaryHtml += `</div>`;
                progressDiv.innerHTML += summaryHtml;
            }

            // Update title
            autoContainer.querySelector('h4').innerHTML = `
                <i class="fas fa-check-circle"></i> Automatic Investigation Complete
            `;
        }

        // Helper function for fetch with retry (no timeout - let the server finish)
        async function fetchWithRetry(url, options, maxRetries = 5) {
            let lastError;

            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    // Fetch without timeout - let the server respond when ready
                    const response = await fetch(url, options);
                    return response;
                } catch (error) {
                    lastError = error;

                    // If it's a network error and not the last attempt, wait and retry
                    const isNetworkError = (
                        error.name === 'TypeError' ||
                        error.message.includes('NetworkError') ||
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('network') ||
                        error.message.includes('Network')
                    );

                    if (attempt < maxRetries && isNetworkError) {
                        const waitTime = 3000 + (attempt * 2000); // 3s, 5s, 7s, 9s, 11s
                        console.log(`Attempt ${attempt + 1}/${maxRetries} failed (${error.message}), retrying in ${waitTime/1000}s...`);

                        // Update UI if present
                        const loadingText = document.querySelector('[id^="loading-"] div div:last-child');
                        if (loadingText) {
                            loadingText.textContent = `Reconnecting... attempt ${attempt + 2}/${maxRetries + 1}`;
                        }

                        await new Promise(resolve => setTimeout(resolve, waitTime));
                        continue;
                    }

                    throw error;
                }
            }

            throw lastError;
        }

        // Document deep dive (with async polling)
        async function deepDive(docId, context) {
            const resultsContent = document.getElementById('resultsContent');

            // Add loading for this document
            const loadingDiv = document.createElement('div');
            loadingDiv.id = `loading-${docId}`;
            loadingDiv.innerHTML = `
                <div style="background: rgba(168, 85, 247, 0.1); padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--accent-purple);">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--accent-purple);"></i>
                        <div>
                            <div style="font-weight: 600; color: var(--accent-purple);">Analyzing ${docId}...</div>
                            <div id="progress-text-${docId}" style="font-size: 12px; color: var(--text-muted);">Starting analysis...</div>
                        </div>
                    </div>
                </div>
            `;
            resultsContent.appendChild(loadingDiv);
            loadingDiv.scrollIntoView({behavior: 'smooth'});

            try {
                // Start the job
                const startResponse = await fetch('/api/investigations/deep-dive', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({doc_id: docId, context: context})
                });

                const startData = await startResponse.json();

                // If it's an immediate error (e.g. name instead of doc_id)
                if (startData.error) {
                    loadingDiv.remove();
                    // Handle as before
                    if (startData.is_search_term) {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.innerHTML = `
                            <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 10px; margin-top: 10px; border: 1px solid #ffd700;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <i class="fas fa-lightbulb" style="color: #ffd700; font-size: 24px;"></i>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #ffd700; margin-bottom: 8px;">
                                            "${docId}" looks like a name, not a document ID
                                        </div>
                                        <div style="color: var(--text-muted); margin-bottom: 15px;">
                                            To analyze documents about a person:
                                            <ol style="margin: 10px 0 0 20px; padding: 0;">
                                                <li>Use the field <strong>"Search for more documents"</strong> below</li>
                                                <li>Enter the person's name</li>
                                                <li>Click <strong>"Analyze"</strong> on the specific document</li>
                                            </ol>
                                        </div>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <button onclick="document.getElementById('searchMoreDocs').value='${docId}'; searchMoreDocuments(); this.closest('div[style*=background]').parentElement.remove();"
                                                    style="padding: 10px 20px; background: var(--accent-purple); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                                <i class="fas fa-search"></i> Search "${docId}" in documents
                                            </button>
                                            <button onclick="this.closest('div[style*=background]').parentElement.remove();"
                                                    style="padding: 10px 20px; background: var(--bg-input); border: 1px solid var(--text-muted); color: var(--text); border-radius: 6px; cursor: pointer;">
                                                <i class="fas fa-times"></i> Close
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        resultsContent.appendChild(suggestionDiv);
                        return;
                    }
                    throw new Error(startData.error);
                }

                const jobId = startData.job_id;
                if (!jobId) {
                    throw new Error('Job ID not received');
                }

                // Polling to check status
                const progressText = document.getElementById(`progress-text-${docId}`);
                let data = null;

                while (true) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Poll every 2 seconds

                    const statusResponse = await fetch(`/api/investigations/deep-dive/status/${jobId}`);
                    const status = await statusResponse.json();

                    // Update progress
                    if (progressText && status.progress) {
                        progressText.textContent = status.progress;
                    }

                    if (status.status === 'completed') {
                        data = status.result;
                        break;
                    } else if (status.status === 'error') {
                        throw new Error(status.error || 'Error during analysis');
                    }
                    // Otherwise continue polling
                }

                loadingDiv.remove();

                if (!data) {
                    throw new Error('No results received');
                }

                // Integrate findings into the overall analysis
                if (currentMergeId) {
                    // Show integration message
                    const integratingDiv = document.createElement('div');
                    integratingDiv.innerHTML = `
                        <div style="background: rgba(0, 212, 255, 0.1); padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid var(--accent);">
                            <i class="fas fa-spinner fa-spin" style="color: var(--accent);"></i>
                            <span style="margin-left: 10px;">Integrating findings into analysis...</span>
                        </div>
                    `;
                    document.getElementById('resultsContent').appendChild(integratingDiv);

                    try {
                        const integrateResponse = await fetchWithRetry('/api/investigations/merge/integrate', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                merge_id: currentMergeId,
                                new_findings: data
                            })
                        });

                        const integratedData = await integrateResponse.json();
                        integratingDiv.remove();

                        if (integratedData.error) {
                            renderDeepDiveResults(docId, data);
                        } else {
                            renderResults(integratedData);
                        }
                    } catch (integrationError) {
                        console.warn('Integration failed, showing direct results:', integrationError);
                        integratingDiv.remove();
                        renderDeepDiveResults(docId, data);
                    }
                } else {
                    renderDeepDiveResults(docId, data);
                }

            } catch (error) {
                const errDiv = document.getElementById(`loading-${docId}`);
                if (errDiv) errDiv.remove();

                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                    <div style="background: rgba(255, 107, 107, 0.1); padding: 20px; border-radius: 8px; margin-top: 10px; border: 1px solid #ff6b6b;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i>
                                <strong>Analysis error ${docId}:</strong> ${error.message}
                            </div>
                            <button onclick="this.parentElement.parentElement.parentElement.remove(); deepDive('${docId}', '${context.replace(/'/g, "\\'")}');"
                                    style="padding: 8px 15px; background: var(--accent-purple); border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('resultsContent').appendChild(errorDiv);
            }
        }

        // Render deep dive results
        function renderDeepDiveResults(docId, data) {
            const resultsContent = document.getElementById('resultsContent');

            let html = `
                <div style="background: var(--bg-card); padding: 25px; border-radius: 12px; margin-top: 20px; border: 2px solid var(--accent-purple);">
                    <h4 style="color: var(--accent-purple); margin: 0 0 15px 0;">
                        <i class="fas fa-file-search"></i> Deep Analysis: ${docId}
                    </h4>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                        ${data.title || ''}
                    </div>
            `;

            // Summary
            if (data.document_summary) {
                html += `<p style="margin-bottom: 15px;">${data.document_summary}</p>`;
            }

            // Key findings
            if (data.key_findings && data.key_findings.length > 0) {
                html += `<h5 style="color: var(--accent-gold); margin: 15px 0 10px;"><i class="fas fa-star"></i> Key Findings</h5>`;
                html += `<ul style="margin-left: 20px;">`;
                data.key_findings.forEach(f => html += `<li>${f}</li>`);
                html += `</ul>`;
            }

            // Financial transactions
            if (data.financial_transactions && data.financial_transactions.length > 0) {
                html += `<h5 style="color: #2ed573; margin: 15px 0 10px;"><i class="fas fa-money-bill-wave"></i> Financial Transactions</h5>`;
                data.financial_transactions.forEach(t => {
                    html += `
                        <div style="background: rgba(46, 213, 115, 0.1); padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #2ed573;">
                            <strong>${t.amount || 'N/A'}</strong> - ${t.from || '?'} → ${t.to || '?'}
                            ${t.date ? `(${t.date})` : ''}
                            ${t.purpose ? `- ${t.purpose}` : ''}
                        </div>
                    `;
                });
            }

            // Red flags
            if (data.red_flags && data.red_flags.length > 0) {
                html += `<h5 style="color: #ff6b6b; margin: 15px 0 10px;"><i class="fas fa-exclamation-triangle"></i> Red Flags</h5>`;
                html += `<ul style="background: rgba(255, 107, 107, 0.1); padding: 15px 15px 15px 35px; border-radius: 8px; border-left: 3px solid #ff6b6b;">`;
                data.red_flags.forEach(f => html += `<li style="margin-bottom: 8px;">${f}</li>`);
                html += `</ul>`;
            }

            // Trafficking references
            if (data.trafficking_references && data.trafficking_references.length > 0) {
                html += `<h5 style="color: #ff0000; margin: 15px 0 10px;"><i class="fas fa-skull-crossbones"></i> Trafficking References</h5>`;
                html += `<div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid #ff0000;">`;
                data.trafficking_references.forEach(t => html += `<p style="font-style: italic;">"${t}"</p>`);
                html += `</div>`;
            }

            // Related documents to investigate
            if (data.related_documents && data.related_documents.length > 0) {
                html += `<h5 style="color: var(--accent-purple); margin: 15px 0 10px;"><i class="fas fa-link"></i> Related Documents</h5>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 8px;">`;
                data.related_documents.forEach(d => {
                    html += `
                        <button onclick="deepDive('${d}', 'Related to ${docId}')"
                                style="padding: 6px 12px; background: var(--bg-input); border: 1px solid var(--accent-purple); color: var(--accent-purple); border-radius: 15px; cursor: pointer; font-size: 12px;">
                            ${d} <i class="fas fa-arrow-right"></i>
                        </button>
                    `;
                });
                html += `</div>`;
            }

            // Conclusion
            if (data.conclusion) {
                html += `
                    <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong style="color: var(--accent);">Conclusion:</strong> ${data.conclusion}
                    </div>
                `;
            }

            html += `</div>`;

            resultsContent.insertAdjacentHTML('beforeend', html);

            // Scroll to new content
            resultsContent.lastElementChild.scrollIntoView({behavior: 'smooth'});
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US');
            } catch {
                return dateStr;
            }
        }

        // Load saved merges
        async function loadSavedMerges() {
            try {
                const response = await fetch('/api/investigations/merges');
                const data = await response.json();
                const merges = data.merges || [];

                const container = document.getElementById('savedMergesList');

                if (merges.length === 0) {
                    document.getElementById('savedMergesPanel').style.display = 'none';
                    return;
                }

                container.innerHTML = merges.map(m => `
                    <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px solid transparent; transition: all 0.3s; flex: 1; min-width: 250px; max-width: 400px; position: relative;" onmouseover="this.style.borderColor='var(--accent-purple)'" onmouseout="this.style.borderColor='transparent'">
                        <button onclick="event.stopPropagation(); deleteMerge('${m.id}')" style="position: absolute; top: 8px; right: 8px; background: rgba(255,107,107,0.2); border: none; color: var(--accent-red); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='var(--accent-red)'; this.style.color='white'" onmouseout="this.style.background='rgba(255,107,107,0.2)'; this.style.color='var(--accent-red)'" title="Delete merge">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div onclick="loadMerge('${m.id}')" style="cursor: pointer;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">
                                <i class="fas fa-calendar"></i> ${formatDate(m.date)}
                            </div>
                            <div style="font-size: 13px; margin-bottom: 8px;">
                                ${m.investigations_merged.map(i => `<span style="background: var(--accent-purple); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px;">${i.substring(0, 20)}...</span>`).join('')}
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted); padding-right: 25px;">
                                ${m.summary ? m.summary.substring(0, 100) + '...' : 'Click to view'}
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading merges:', error);
                document.getElementById('savedMergesPanel').style.display = 'none';
            }
        }

        // Delete a saved merge
        async function deleteMerge(mergeId) {
            if (!confirm('Are you sure you want to delete this merge?')) {
                return;
            }

            try {
                const response = await fetch(`/api/investigations/merge/${mergeId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    // Reload the list
                    loadSavedMerges();
                } else {
                    alert('Error: ' + (data.error || 'Cannot delete'));
                }
            } catch (error) {
                console.error('Error deleting merge:', error);
                alert('Error during deletion');
            }
        }

        // Load a saved merge
        async function loadMerge(mergeId) {
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsContent = document.getElementById('resultsContent');

            resultsPanel.classList.add('active');
            resultsContent.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading merge...</p>
                </div>
            `;

            try {
                const response = await fetch(`/api/investigations/merge/${mergeId}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                currentMergeId = mergeId;  // Save for future integrations
                renderResults(data.result || data);

            } catch (error) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Init
        loadInvestigations();
        loadSavedMerges();
    </script>
</body>
</html>
